




<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Geindock Suite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="assets/bootstrap/bootstrap.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"  integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer"  />
    <style>
      body {
        background-color: #f8f9fa;
      }

      .main-content {
        margin-top: 2rem;
      }
      #viewport1,
      #view3d_lig {
        width: 100%;
        height: 100%;
        min-height: 300px;
      }
      .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
      }
      .card-body-fixed {
        height: 345px;
      }
      .card-header {
        background-color: #1e2a78;
        background-color: #bbdefb;
        color: #1e2a78;
        border-radius: 10px 10px 0 0 !important;
        font-size: 0.9rem; /* Reduced font size */
      }
      .card-header h5 {
        font-size: 1rem;
        margin-bottom: 0;
      }
      .drop-container {
        border: 2px dashed #1e2a78;
        border: 2px dashed #bbdefb;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .drop-container:hover {
        background-color: #e9ecef;
        border-color: #0d47a1;
      }
      .drop-title {
        color: #1e2a78;
        font-size: 1.2rem;
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }
      .file-icon {
        font-size: 2rem;
        color: #1e2a78;
        margin-bottom: 1rem;
      }
      .btn-primary {
        background-color: #1e2a78;
        border-color: #1e2a78;
      }
      .btn-primary:hover {
        background-color: #0d47a1;
        border-color: #0d47a1;
      }
      .ngl-viewer {
        background-color: #e9ecef;
        border-radius: 10px;
        height: 500px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #6c757d;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        visibility: hidden;
      }
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #1e2a78;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

       /* New styles for the table */
       .table-container {
        margin-top: 2rem;
        overflow-x: auto;
      }
      .material-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: #fff;
        box-shadow: 0 2px 5px 0 rgba(0,0,0,0.16), 0 2px 10px 0 rgba(0,0,0,0.12);
        border-radius: 4px;
      }
      .material-table th,
      .material-table td {
        padding: 15px;
        text-align: left;
      }
      .material-table thead {
        background-color: #3f51b5;
        background-color: #bbdefb;
        color: white;
        color: black;
      }
      .material-table th {
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .material-table tbody tr:nth-child(even) {
        background-color: #f5f5f5;
      }
      .material-table tbody tr:hover {
        background-color: #eeeeee;
      }
      .status-pending {
        color: #ff9800;
      }
      .status-complete {
        color: #4caf50;
      }
      .status-failed {
        color: #f44336;
      }
      .btn-action {
        padding: 5px 10px;
        margin: 2px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .btn-view {
        background-color: #2196f3;
        color: white;
      }
      .btn-delete {
        padding: 5px 10px;
        margin: 2px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        
      }
      .btn-action:hover {
        opacity: 0.8;
      }




      
    </style>
    <script>


    </script>
  </head>
  <body>
    <div id="loading" class="loading-overlay">
      <div class="loading-spinner"></div>
    </div>

    <div id="navbar-placeholder" class="container"></div>

    <div class="jumbotron bg-light" style="margin-top: 5px; padding-top: 5px">
      <div class="container mt-0">
        <div class="row">
          <div class="col-12">
              <div class="card text-center mb-4">
                  <div class="card-header">
                      <h5 class="mb-0">GeinDock Suite</h5>
                  </div>
              </div>
          </div>
      </div>


        <div class="row">
          <div class="col-md-4" style="width: 100%; height: 300px !important">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Protein Preparation</h5>
              </div>
              <div class="card-body card-body-fixed">
                <div class="drop-container" id="protein-drop-container">
                  <i class="fas fa-dna file-icon"></i>
                  <p class="drop-title">Drop or Choose Protein File</p>
                  <input
                    type="file"
                    id="protein-file"
                    accept=".pdb,.mol2"
                    style="display: none"
                  />
                </div>
                <button
                  class="btn btn-primary btn-block mt-3"
                  onclick="uploadFile('protein')"
                >
                  Upload Protein
                </button>
              </div>
            </div>
          </div>

          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Protein Viewer</h5>
              </div>
              <div class="card-body">
                <div id="viewport1"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- New row for grid box controls -->
         <!--
<div class="row mt-3">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Grid Box Controls</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-2">
            <label for="grid-center-x">Center X:</label>
            <input type="number" id="grid-center-x" class="form-control" value="0">
          </div>
          <div class="col-md-2">
            <label for="grid-center-y">Center Y:</label>
            <input type="number" id="grid-center-y" class="form-control" value="0">
          </div>
          <div class="col-md-2">
            <label for="grid-center-z">Center Z:</label>
            <input type="number" id="grid-center-z" class="form-control" value="0">
          </div>
          <div class="col-md-2">
            <label for="grid-size-x">Size X:</label>
            <input type="number" id="grid-size-x" class="form-control" value="10">
          </div>
          <div class="col-md-2">
            <label for="grid-size-y">Size Y:</label>
            <input type="number" id="grid-size-y" class="form-control" value="10">
          </div>
          <div class="col-md-2">
            <label for="grid-size-z">Size Z:</label>
            <input type="number" id="grid-size-z" class="form-control" value="10">
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-4">
            <label for="grid-color">Grid Color:</label>
            <input type="color" id="grid-color" class="form-control" value="#ff0000">
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary mt-4" onclick="updateGridBox()">Update Grid Box</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

-->











        <!--Ligand starts from here-->

        <div class="row mt-0">
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Ligand Preparation</h5>
              </div>
              <div class="card-body card-body-fixed">
                <div class="drop-container" id="ligand-drop-container">
                  <i class="fas fa-capsules file-icon"></i>
                  <!--<p class="drop-title">Drop or Choose Ligand File</p>-->
                  <p class="drop-title">Please select a ligand file in one of the following formats: mol2, mol, sdf, or pdb.</p>
                  <input
                    type="file"
                    id="ligand-file"
                    accept=".pdb,.mol2,.sdf"
                    style="display: none"
                  />
                </div>
                <button
                  class="btn btn-primary btn-block mt-3"
                  onclick="uploadFile('ligand')"
                >
                  Upload Ligand
                </button>
              </div>
            </div>
          </div>

          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Ligand Viewer</h5>
              </div>
              <div class="card-body">
                <div id="view3d_lig"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="row mt-0">
          <button class="btn btn-primary shadow mr-2" onclick="startDocking()">Start Docking</button>
          <button class="btn btn-primary shadow mr-2" onclick="startDocking()">New Job</button>
          <button class="btn btn-primary shadow mr-2" onclick="startDocking()">Reset</button>
            
        </div>
        <div class="row mt-4">
            <div class="col-12">
              <div class="table-container">
                <table class="material-table" id="jobTable">
                  <thead>
                    <tr>
                      <th>Submit</th>
                      <th>Protein</th>
                      <th>Ligand</th>
                      <th>Job Type</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                  <!--  <tr>
                      <td>2023-09-01</td>
                      <td>Protein A</td>
                      <td>Ligand X</td>
                      <td>Docking</td>
                      <td><span class="status-pending">Pending</span></td>
                      <td>
                        <button type="button" class="btn btn-outline-primary">View</button>
                        <button type="button" class="btn btn-outline-success">Email</button>
                      </td>
                    </tr>
                    <tr>
                      <td>2023-08-30</td>
                      <td>Protein B</td>
                      <td>Ligand Y</td>
                      <td>Analysis</td>
                      <td><span class="status-complete">Complete</span></td>
                      <td>
                        <button type="button" class="btn btn-outline-primary">View</button>
                        <button type="button" class="btn btn-outline-success">Email</button>
                      </td>
                    </tr>
                    <tr>
                      <td>2023-08-29</td>
                      <td>Protein C</td>
                      <td>Ligand Z</td>
                      <td>Simulation</td>
                      <td><span class="status-failed">Failed</span></td>
                      <td>
                        <button type="button" class="btn btn-outline-primary">View</button>
                        <button type="button" class="btn btn-outline-success">Email</button>
                      </td>
                    </tr>-->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer>
      <div class="container">
          <div>
              <hr class="mt-0">
          </div>
          <h3></h3>
      </div>
      <div class="container py-4 py-lg-5">
          <div class="table-responsive">
              <table class="table">
                  <thead>
                      <tr></tr>
                  </thead>
                  <tbody>
                      <tr></tr>
                  </tbody>
              </table>
          </div>
          <div class="row row-cols-2 row-cols-md-4">
              <div class="col-12 col-md-3">
                  <div class="fw-bold d-flex align-items-center mb-2"><span>Geinforce Technology</span></div>
                  <p class="text-muted">Innovating the future of drug discovery through advanced software solutions and expert consultancy.</p>
              </div>
              <div class="col-sm-4 col-md-3 text-lg-start d-flex flex-column">
                  <h3 class="fs-6 fw-bold">Services</h3>
                  <ul class="list-unstyled">
                      <li><a href="geindock.html">GeinDock Suite</a></li>
                      <li><a href="#">ForceADME</a></li>
                      <li><a href="#">Forcephrase</a></li>
                  </ul>
              </div>
              <div class="col-sm-4 col-md-3 text-lg-start d-flex flex-column">
                  <h3 class="fs-6 fw-bold">About</h3>
                  <ul class="list-unstyled">
                      <li><a href="aboutus.html">About Us</a></li>
                      <li><a href="#">Team</a></li>
                      <li><a href="contacts.html">Contact Us</a></li>
                  </ul>
              </div>
              <div class="col-sm-4 col-md-3 text-lg-start d-flex flex-column">
                  <h3 class="fs-6 fw-bold">Legals</h3>
                  <ul class="list-unstyled">
                      <li><a href="Privacy%20Policy.html" target="_top">Privacy Policy</a></li>
                      <li><a href="Terms%20of%20Use.html">Terms of Use</a></li>
                      <li><a href="#">Refund Policy</a></li>
                  </ul>
              </div>
          </div>
          <hr>
          <div class="text-muted d-flex justify-content-between align-items-center pt-3">
              <p class="align-content-start mb-0 me-xl-5 pe-xl-0">Copyright © 2024&nbsp;Geinforce Technology Private Limited&nbsp;<br><br></p>
              <ul class="list-inline mb-0">
                  <li class="list-inline-item"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-facebook">
                          <path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951"></path>
                      </svg></li>
                  <li class="list-inline-item"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-twitter">
                          <path d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15"></path>
                      </svg></li>
                  <li class="list-inline-item"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-instagram">
                          <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334"></path>
                      </svg></li>
              </ul>
          </div>
      </div>
  </footer>
<!--
    <script src="assets/js/jquery-3.2.1.slim.min.js"></script>
    <script src="assets/js/popper.min.js" crossorigin="anonymous"></script>
    <script src="assets/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="assets/js/jquery-3.5.1.min.js"></script>
    <script src="assets/js/ngl.js"></script>
-->
<script src="assets/js/toast.js"></script>
<script src="https://unpkg.com/ngl@2.0.0-dev.37/dist/ngl.js"></script>
<script src="assets/js/jquery-3.5.1.min.js" defer></script>
<script src="assets/js/popper.min.js" crossorigin="anonymous" defer></script>
<script src="assets/js/bootstrap.min.js" crossorigin="anonymous" defer></script>
<script src="assets/js/ngl.js"></script>
    <script>
    // Call this function when the window loads
window.onload = async function() {
  $(function(){
    $("#navbar-placeholder").load("nav.html", function() {
        // This function will be called after the navbar is loaded
        updateNavbar();
    });
}); 
async function updateNavbar() {
            const loginButton = document.querySelector('#navbar-placeholder #login-button');
            if (!loginButton) {
                console.error('Login button not found');
                return;
            }

            const isValid = await isJwtTokenValid();
            
            if (isValid) {
                loginButton.innerHTML = '<a class="btn btn-primary shadow ml-auto mr-2" role="button" href="#" onclick="logout()">Logout</a>';
            } else {
                loginButton.innerHTML = '<a class="btn btn-primary shadow ml-auto mr-2" role="button" href="login.html">Login</a>';
            }
        }
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = 'login.html';
        }




  const token = localStorage.getItem('jwtToken');
  const isValid = await isJwtTokenValid();
  console.log('token',token)
  if (!token || !isValid) {
        // Token not found, redirect to login page
        console.log('No JWT token found. Redirecting to login page...');
        window.location.href = 'login.html';
    } else {
        // Token found, proceed with loading the page content
        console.log('JWT token found. Loading page content...');
        getJobsAndAddToTable();
    }

  //  getJobsAndAddToTable();
};



    
      function showLoading() {
        document.getElementById("loading").style.visibility = "visible";
      }

      function hideLoading() {
        document.getElementById("loading").style.visibility = "hidden";
      }

      function uploadFile(type) {
        const fileInput = document.getElementById(`${type}-file`);
        const dropTitle = document.querySelector(
          `#${type}-drop-container .drop-title`
        );
        const token = localStorage.getItem("jwtToken");

      

        if (!token) {
          showToast('No JWT token found. Please log in again.','error');
          return;
        }

        if (!fileInput.files || fileInput.files.length === 0) {
         // alert("Please select a file first.");
         // alert(` Please upload a ${type} file to proceed.`);
          showToast(` Please upload a ${type} file to proceed.`, 'error');
          return;
        }

        const file = fileInput.files[0];
        let jobName = localStorage.getItem("jobName") || new Date().getTime();
        localStorage.setItem("jobName", jobName);
        const formData = new FormData();
        formData.append("file", file);
        formData.append("jobName", jobName);

        if (type === "protein") {
          let data = {
            center: {
                      x: 0,
                      y: 0,
                      z: 0
              },
            size: {
                    x: 0,
                    y: 0,
                    z: 0
              }
          }



          formData.append("coordinates", JSON.stringify(data));
        }

        showLoading();

        const uploadUrl =
          type === "protein"
            ? "/GeinForce/api/serverDockUpload"
            : "/GeinForce/api/serverDockUploadLigand";

        fetch(uploadUrl, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
          },
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              return response.text().then((text) => {
                throw new Error(`Network response was not ok: ${text}`);
              });
            }
            return response.json();
          })
          .then((data) => {
            console.log("Upload successful:", data);
            hideLoading();
           // alert(`${type.charAt(0).toUpperCase() + type.slice(1)} file uploaded successfully`);
            showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} file uploaded successfully`,'success');

          })
          .catch((error) => {
            console.error("Error:", error);
            hideLoading();
            if (
              error.message.includes(
                "JWT strings must contain exactly 2 period characters"
              )
            ) {
              //alert("Invalid token. Please log in again.");
              showToast('Invalid token. Please log in again.','error');
              localStorage.removeItem("jwtToken");
            } else {
              alert(`Error uploading ${type} file: ${error.message}`);
              showToast(`Error uploading ${type} file: ${error.message}`,'error');
            }
          });
      }
      document.addEventListener("DOMContentLoaded", (event) => {
        ["protein", "ligand"].forEach((type) => {
          const dropContainer = document.getElementById(
            `${type}-drop-container`
          );
          const fileInput = document.getElementById(`${type}-file`);

          dropContainer.addEventListener("click", () => fileInput.click());

          dropContainer.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropContainer.classList.add("drag-active");
          });

          dropContainer.addEventListener("dragleave", () => {
            dropContainer.classList.remove("drag-active");
          });

          dropContainer.addEventListener("drop", (e) => {
            e.preventDefault();
            dropContainer.classList.remove("drag-active");
            fileInput.files = e.dataTransfer.files;
            updateFileName(type);
            // alert(type);
            if (type == "protein") {
              loadProtein(fileInput);
            }
            if (type == "ligand") {
              loadLigand(fileInput);
            }
          });

          fileInput.addEventListener("change", () => {
            updateFileName(type);
            // alert(type);
            if (type === "protein") {
              loadProtein(fileInput);
            }
            if (type == "ligand") {
              loadLigand(fileInput);
            }
          });
        });
      });

      function updateFileName(type) {
        const fileInput = document.getElementById(`${type}-file`);
        const dropTitle = document.querySelector(
          `#${type}-drop-container .drop-title`
        );
        if (fileInput.files.length > 0) {
          dropTitle.textContent = fileInput.files[0].name;
        } else {
          dropTitle.textContent = `Drop or Choose ${
            type.charAt(0).toUpperCase() + type.slice(1)
          } File`;
        }
      }

      var stage = new NGL.Stage("viewport1", {
        backgroundColor: "white",
        cameraType: "orthographic",
      });
      //for grid
      var gridBoxComponent;
      var stage_ligand = new NGL.Stage("view3d_lig", {
        backgroundColor: "white",
        cameraType: "orthographic",
      });
      window.addEventListener(
        "resize",
        function (event) {
          stage.handleResize();
          stage_ligand.handleResize();
        },
        false
      );

      function loadProtein(input) {
        // alert("load protein");
        if (input.files && input.files[0]) {
          //  showProteinViewDiv();
          var reader = new FileReader();
          reader.onload = function (e) {
            stage.setParameters({ backgroundColor: "white" });
            stage
              .loadFile(new Blob([e.target.result], { type: "text/plain" }), {
                ext: "pdb",
                defaultRepresentation: true,
              })
              .then(function (component) {
                proteinComponent = component;
                component.addRepresentation("cartoon");
                stage.autoView();
                //updateBox();
              });
          };
          reader.readAsText(input.files[0]);
          //SHOWING DEFAULT GRID BOX
          color = hexToRgb(document.getElementById("color").value);
          color_list = [color.r / 255, color.g / 255, color.b / 255];
          var pos = [x_center, y_center, z_center];
          var size = [x_size, y_size, z_size];
          shape = new NGL.Shape("shape");
          shape = new NGL.Shape("shape", { lineWidth: 10, aspectRatio: 10 });
          shape.addBox(
            pos, // position
            color_list, // color
            size[0], // size
            [0, size[1], 0], // height
            [0, 0, size[2]]
          ); // depth
          shapeComp = stage.addComponentFromObject(shape);
          repr = shapeComp.addRepresentation("buffer", { opacity: 0.5 });
          // shapeComp.autoView();
          stage.viewer.render();
          // alert("stage loaded")
        }
      }
      function hexToRgb(hex) {
        // Convert Hex color to rgb fomat
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result
          ? {
              r: parseInt(result[1], 16),
              g: parseInt(result[2], 16),
              b: parseInt(result[3], 16),
            }
          : null;
      }

      function loadLigand(input) {
        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function (e) {
            stage_ligand.setParameters({ backgroundColor: "white" });
            stage_ligand.removeAllComponents();
            stage_ligand
              .loadFile(new Blob([e.target.result], { type: "text/plain" }), {
                ext: input.files[0].name.split(".").pop().toLowerCase(),
                defaultRepresentation: true,
              })
              .then(function (component) {
                component.addRepresentation("ball+stick");
                stage_ligand.autoView();
              });
          };
          reader.readAsText(input.files[0]);
        }
      }
    
      function checkFilesUploaded(jobName) {
        const token = localStorage.getItem('jwtToken');
        return fetch(`/GeinForce/api/checkUpload?jobName=${jobName}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
        .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          return response.text();
        });
      }
      async function startDocking() {
          const jobName = localStorage.getItem('jobName');
          const token = localStorage.getItem('jwtToken');
          localStorage.setItem('jobName','');
          console.log('reset jobName'+localStorage.getItem('jobName'));
          if (!jobName) {
              //alert("No job name found. Please create a new job before starting docking.");
              showToast('No job name found. Please create a new job before starting docking.','error');
              return;
            }
            const job = await getJobDetails(jobName);
            checkFilesUploaded(jobName)
            .then(response=>{
              if (response !== "Success:Files Uploaded") {
                showToast(response,'success');

                throw new Error( response);
              }
             // alert(response);
             // establishSseConnection();
             //add job in table
             
           //  console.log(job);
             addJobToTable(job);
             showToast('Docking process initiated. Please wait while the operation completes.','success');
             
             const sseConnection = establishSseConnection(jobName);

            // console.log("connection.....");
              var formData = new FormData();
              formData.append('jobName', jobName);


              fetch('/GeinForce/api/serverDock', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`
                },
                body: formData,
              })
              .then(response => response.text())
                .then(text => {
                     // console.log(text);
                      //establishSseConnection(); // Establish SSE connection after initiating docking
                  })
                  .catch(error => console.error('Error initiating docking:', error));          
            });
}


function establishSseConnection(jobName ){
    const token = localStorage.getItem('jwtToken');
    const email = localStorage.getItem('email');
   // console.log('Establishing SSE connection...',email);
    
    // const eventSource = new EventSource('/stream-updates', {
    //     headers: {
    //         'Authorization': `Bearer ${token}`
    //     },
    //     withCredentials: true
    // });

    const eventSource = new EventSource(`/GeinForce/stream-updates?jobName=${jobName}`);

    eventSource.onopen = function(event) {
     //   console.log('SSE connection opened');
    };

    eventSource.onmessage = function(event) {
      //  console.log('Received SSE message:', event.data);
        try {
            // Check if the message is a valid JSON string
            if (event.data.startsWith('{') && event.data.endsWith('}')) {
              
                const update = JSON.parse(event.data);
                const progressBar = document.getElementById(`progress-${jobName}`);
                
                if (progressBar) {
                 // console.log("get JSON message"+ update.status);
                    const status = update.status; // Assuming status is a number between 1 and 10
                    const progressPercentage = (status / 10) * 100; // Convert status to percentage
                   // console.log("get JSON message"+progressPercentage);
                    progressBar.style.width = `${progressPercentage}%`;
                    progressBar.textContent = ` ${status} %`; // Update the text inside the progress bar
                    if(status==10){
                      progressBar.textContent = `completed`;
                    }
                    // Optionally, you could change the color based on progress
                    if (progressPercentage === 100) {
                        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                        progressBar.classList.add('bg-success'); // Make it green when complete
                    }
                }

                if (event.data.includes("Task completed. Closing connection.")) {
                  //  console.log('Job completed, closing SSE connection');
                    eventSource.close();
                }
            } else {
              //  console.log('Non-JSON message received:', event.data);
            }
        } catch (error) {
            console.error('Error parsing SSE message:', error);
        }


        if (event.data.includes("Task completed. Closing connection.")) {
          //  console.log('Job completed, closing SSE connection');
            eventSource.close();
        }
        // Handle the update here
    };

    eventSource.onerror = function(error) {
        console.error('SSE connection error:', error);
        eventSource.close();
        // Implement reconnection logic here if needed
    };

    return eventSource;
}

function getJobDetails(jobName) {
        const token = localStorage.getItem('jwtToken');

        if (!token) {
          return Promise.reject(new Error("No authentication token found"));
        }

        return fetch(`/GeinForce/api/getJobByName?jobName=${jobName}`, {
          method: 'GET',
          headers: {
              'Authorization': `Bearer ${token}`
          }
        })
        .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          return response.json();
        })
          .then(data => {
          //  console.log("Job details:", data);
            return data;
          });
      }
function addJobToTable(job) {
   // console.log("Adding job in table "+job);
    const table = document.getElementById('jobTable');
    const tbody = table.querySelector('tbody');
    
    const newRow = tbody.insertRow();
    
    // Submit column
    const submitCell = newRow.insertCell();
    const timestamp = parseInt(job.jobName, 10);
    const date = new Date(timestamp);
   // const formattedDateTime = date.toLocaleString();
   const formattedDateTime = date.toLocaleString('en-GB', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
}).replace(/\//g, '-');


    //submitCell.textContent = formattedDateTime;
    submitCell.textContent=formatDate(job.jobName);

    // Protein column
    const proteinCell = newRow.insertCell();
    const cleanedProteinFile = job.proteinFile.replace(`${job.jobName}_`, '').trim();
    proteinCell.textContent =cleanedProteinFile;

    // Ligand column
    const ligandCell = newRow.insertCell();
    ligandCell.textContent = job.ligandFiles.replace(`${job.jobName}_`, '').trim();

    // Job Type column
    const jobTypeCell = newRow.insertCell();
    jobTypeCell.textContent = job.jobType || 'Docking'; // Add job type if available, otherwise 'N/A'


    // Status column with progress bar
    const statusCell = newRow.insertCell();
    const progressBarContainer = document.createElement('div');
    progressBarContainer.className = 'progress';

    const progressBar = document.createElement('div');
    progressBar.id = `progress-${job.jobName}`;
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
    progressBar.role = 'progressbar';
    progressBar.ariaValuenow = 0;
    progressBar.ariaValuemin = 0;
    progressBar.ariaValuemax = 100;
    progressBar.style.width = '0%'; // Initial width
    progressBar.textContent = 'Pending'; // Initial status text

    progressBarContainer.appendChild(progressBar);
    statusCell.appendChild(progressBarContainer);

    // Actions column
    const actionsCell = newRow.insertCell();
     // View button
     const viewButton = document.createElement('button');
    viewButton.type = 'button';
    viewButton.className = 'btn btn-outline-primary';
    viewButton.textContent = 'View';
    viewButton.onclick = function() { 
    const url = `dockoutput.html?jobName=${encodeURIComponent(job.jobName)}`;
    window.location.href = url;
};
    actionsCell.appendChild(viewButton);

    // Add a space between buttons
    actionsCell.appendChild(document.createTextNode(' '));

    // Email button
    const emailButton = document.createElement('button');
    emailButton.type = 'button';
    emailButton.className = 'btn btn-outline-success';
    emailButton.textContent = 'Email';
    emailButton.onclick = function() { emailJobDetails(job.id); };
    actionsCell.appendChild(emailButton);

    // You can add more action buttons here if needed
} 
function getStatusClass(status) {
    switch(status.toUpperCase()) {
        case 'PENDING': return 'status-pending';
        case 'RUNNING': return 'status-running';
        case 'COMPLETE': return 'status-complete';
        case 'ERROR': return 'status-failed';
        default: return '';
    }
}
function getJobsAndAddToTable() {
  showLoading();
    const token = localStorage.getItem('jwtToken');

    fetch('/GeinForce/api/getJobs', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json(); // Parse the JSON from the response
    })
    .then(jobs => {
      //  console.log('Jobs:', jobs);
        const table = document.getElementById('jobTable');
        const tbody = table.querySelector('tbody');

        jobs.forEach(job => {
            const newRow = tbody.insertRow();

            // Submit column
            const submitCell = newRow.insertCell();
            submitCell.textContent = formatDate(job.jobName); // Assuming jobName contains a timestamp

            // Protein column
            const proteinCell = newRow.insertCell();
            //proteinCell.textContent = job.proteinFile.replace(job.jobName + "_", ""); // Remove jobName from proteinFile
            proteinCell.textContent = job.proteinFile 
                ? job.proteinFile.replace(job.jobName + "_", "") 
                : "No file";

            // Ligand column
            const ligandCell = newRow.insertCell();
            //ligandCell.textContent = job.ligandFiles.replace(job.jobName + "_", ""); // Remove jobName from ligandFiles
            ligandCell.textContent = job.ligandFiles 
                ? job.ligandFiles.replace(job.jobName + "_", "") 
                : "No file";

            // Job Type column
            const jobTypeCell = newRow.insertCell();
            jobTypeCell.textContent = job.jobType || 'Docking'; // Add job type if available, otherwise 'Docking'

            // Status column with progress bar
            const statusCell = newRow.insertCell();
            statusCell.textContent = job.status;

            // Actions column
            const actionsCell = newRow.insertCell();
            const viewButton = document.createElement('button');
            viewButton.type = 'button';
            viewButton.className = 'btn btn-outline-primary';
            viewButton.textContent = 'View';
            viewButton.onclick = function() { 
    const url = `dockoutput.html?jobName=${encodeURIComponent(job.jobName)}`;
    window.location.href = url;
};
            actionsCell.appendChild(viewButton);

            actionsCell.appendChild(document.createTextNode(' ')); // Space between buttons

            const emailButton = document.createElement('button');
            emailButton.type = 'button';
            emailButton.className = 'btn btn-outline-success';
            emailButton.textContent = 'Email';
            emailButton.onclick = function() { emailJobDetails(job.id); };
            actionsCell.appendChild(emailButton);
        });
        hideLoading();
      })
    .catch(error => {
      hideLoading();
        console.error('Error fetching jobs:', error);
    });
}

function formatDate(timestamp) {
    const date = new Date(parseInt(timestamp));
    return date.toLocaleString('en-GB', { 
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit' 
    });
}

async function isJwtTokenValid() {
    // Retrieve the JWT token from localStorage
    const token = localStorage.getItem('jwtToken');

    if (!token) {
        console.error('No token found in localStorage');
        return false;
    }

    // API endpoint URL
    const apiUrl = '/GeinForce/api/validateUser';

    // Set up the request options
    const requestOptions = {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    };

    try {
        const response = await fetch(apiUrl, requestOptions);
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const result = await response.text();
        console.log('Token validation result:', result);

        return result === 'Token is valid';
    } catch (error) {
        console.error('Error validating token:', error);
        localStorage.setItem('jwtToken','');
        return false;
    }
}


function updateGridBox() {
    if (gridBoxComponent) {
        stage.removeComponent(gridBoxComponent);
    }

    var centerX = parseFloat(document.getElementById("grid-center-x").value) || 0;
    var centerY = parseFloat(document.getElementById("grid-center-y").value) || 0;
    var centerZ = parseFloat(document.getElementById("grid-center-z").value) || 0;
    var sizeX = Math.abs(parseFloat(document.getElementById("grid-size-x").value)) || 10;
    var sizeY = Math.abs(parseFloat(document.getElementById("grid-size-y").value)) || 10;
    var sizeZ = Math.abs(parseFloat(document.getElementById("grid-size-z").value)) || 10;
    var color = document.getElementById("grid-color").value || "#ff0000";
    color = hexToRgb(document.getElementById("grid-color").value);
    var shape = new NGL.Shape("gridBox");
    shape = new NGL.Shape("shape", { lineWidth: 10, aspectRatio: 10 });
    var pos = [
        parseFloat(x_center),
        parseFloat(y_center),
        parseFloat(z_center)
      ];
    shape.addBox(
        [
            [centerX - sizeX/2, centerY - sizeY/2, centerZ - sizeZ/2],
            [centerX + sizeX/2, centerY - sizeY/2, centerZ - sizeZ/2],
            [centerX + sizeX/2, centerY + sizeY/2, centerZ - sizeZ/2],
            [centerX - sizeX/2, centerY + sizeY/2, centerZ - sizeZ/2],
            [centerX - sizeX/2, centerY - sizeY/2, centerZ + sizeZ/2],
            [centerX + sizeX/2, centerY - sizeY/2, centerZ + sizeZ/2],
            [centerX + sizeX/2, centerY + sizeY/2, centerZ + sizeZ/2],
            [centerX - sizeX/2, centerY + sizeY/2, centerZ + sizeZ/2]
        ],
        [
            [0, 1, 2], [0, 2, 3], // Front face
            [4, 6, 5], [4, 7, 6], // Back face
            [0, 4, 1], [1, 4, 5], // Left face
            [2, 6, 3], [3, 6, 7], // Right face
            [0, 3, 4], [3, 7, 4], // Top face
            [1, 5, 2], [2, 5, 6]  // Bottom face
        ],
        { color: color, opacity: 0.5 }
    );

    gridBoxComponent = stage.addComponentFromObject(shape);
    gridBoxComponent.addRepresentation("surface");
    stage.autoView();
}
</script>
  </body>
</html>
