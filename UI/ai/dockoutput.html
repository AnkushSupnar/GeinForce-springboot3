<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>GeinDock Suite</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="assets/bootstrap/bootstrap.min.css" crossorigin="anonymous">
    
    <script src="assets/js/jquery-3.5.1.min.js"></script>
    <script src="assets/js/popper.min.js" crossorigin="anonymous"></script>
    <script src="assets/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        body {
    font-family: 'Roboto', Arial, sans-serif;
    color: #333;
    line-height: 1.6;
}
        .selected {
            background-color: #f0f0f0;
            /* Light grey background for selected row */
            color: #000;
            /* Optional: Change text color for selected row */
}
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        .card-header {
            background-color: #bbdefb;
            color: #1e2a78;
            border-radius: 10px 10px 0 0 !important;
            font-size: 0.9rem;
        }
        .card-header h5 {
            font-size: 1rem;
            margin-bottom: 0;
        }
        .file-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .file-link {
            display: block;
            margin-top: 5px;
        }

        /*Table Styling*/
        .table-container {
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden;
    margin: 20px 0;
}

.materialistic-table {
    width: 100%;
    min-width: 800px; /* Adjust based on your content */
    table-layout: fixed;
    border-collapse: collapse;
    background-color: #ffffff;
    
    font-family: 'Poppins', 'Roboto', Arial, sans-serif;
    

}

.materialistic-table thead {
    background-color: #3f51b5;
    background-color: #bbdefb;
    color: #ffffff;
    color: #1e2a78;
    font-family: 'Roboto', Arial, sans-serif;
}

.materialistic-table th {
    padding: 15px;
    text-align: left;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.materialistic-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #e0e0e0;
}

.materialistic-table tbody tr:last-child td {
    border-bottom: none;
}

.materialistic-table tbody tr:hover {
    background-color: #f5f5f5;
    transition: background-color 0.3s ease;
}

.materialistic-table .selected {
    background-color: #e8eaf6;
}

.link-container {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.link-container a {
    color: #3f51b5;
    text-decoration: none;
    margin: 2px 0;
    transition: color 0.3s ease;
}

.link-container a:hover {
    color: #303f9f;
    text-decoration: underline;
}
.table-scroll {
    overflow-x: auto;
    padding-bottom: 15px; /* Space for the scrollbar */
}


/*radio button of table*/
.radio-style-checkbox {
    display: none;
}

.radio-style-label {
    position: relative;
    padding-left: 28px;
    cursor: pointer;
    display: inline-block;
    line-height: 20px;
    font-size: 14px;
    color: #00EA90;
    margin-right: 15px;
}

.radio-style-label:before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 15px;
    height: 15px;
    border: 2px solid #00EA90;
    border-radius: 50%;
    background: #fff;
    transition: all 0.3s ease;
}

.radio-style-checkbox:checked + .radio-style-label:before {
    background-color:#06920d;
    background-color: #00EA90;;
}

.radio-style-checkbox:checked + .radio-style-label:after {
    content: '';
    width: 7.5px;
    height: 7.5px;
    background: #fff;

    position: absolute;
    top: 3px;
    left: 4px;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.radio-style-label:hover:before {
    border-color: #00EA90;
}





    </style>
    <script>
        
        $(function(){
            $("#navbar-placeholder").load("nav.html");
        });

        function showLoading() {
            document.getElementById('loading').style.visibility = 'visible';
        }

        function hideLoading() {
            document.getElementById('loading').style.visibility = 'hidden';
        }
    </script>
</head>
<body>
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div id="navbar-placeholder" class="container"></div>  
    <div class="jumbotron bg-light" style="margin-top: 5px; padding-top: 5px">
        <div class="container mt-0">
            <div class="row">
                <div class="col-12">
                    <div class="card text-center mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">GeinDock Suite - Result Analysis</h5>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Submitted Dockings</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="file-info">
                                        <h6 class="mb-2">Submitted Protein</h6>
                                        <span id="proteinFileName"></span>
                                        <a id="proteinFileLink" href="javascript:void(0);" class="file-link">Download Protein File</a>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="file-info">
                                        <h6 class="mb-2">Submitted Ligand</h6>
                                        <span id="ligandFileName"></span>
                                        <a id="ligandFileLink" href="javascript:void(0);" class="file-link">Download Ligand File</a>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="file-info">
                                        <h6 class="mb-2">Conformations</h6>
                                        <span id="">9</span>
                                        
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--result-->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Result View</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6" id="viewport" style="height:500px;">
                                       
                                </div>
                                <div class="col-md-6">
                                    <div class="table-container">
                                        <div class="table-scroll">
                                            <table class="table materialistic-table">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 15%;">Conformations ID</th>
                                                        <th style="width: 20%;">Binding Affinity (Kcal/mol)</th>
                                                        <th style="width: 25%;">Active site Co-ordinates (X,Y,Z)</th>
                                                        <th style="width: 40%;">Downloads</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>





                                    <!--<div class="table-responsive">
                                        <table class="table text-center table-bordered mb-0">
                                            <thead class="bg-thead text-thead">
                                                <tr>
                                                    <th>Conformations ID</th>
                                                    <th>Binding Affinity (Kcal/mol)</th>
                                                    <th>Active site Co-ordinates (X,Y,Z)</th>
                                                    <th>Downloads</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tableBody"></tbody>
                                        </table>
                                    </div>-->
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>



        </div>
    </div>

    <script src="assets/js/ngl.js"></script>
    
    <script>
        var stage_dock = new NGL.Stage("viewport", { backgroundColor: "white", cameraType: "orthographic" });
        var coordinates;
        let loadedComponentsMap = {};
        window.onload =async function() {
            const token = localStorage.getItem('jwtToken');            
            const isValid = await isJwtTokenValid();
           // console.log('token',token)
        if (!token|| !isValid) {
            // Token not found, redirect to login page
            console.log('No JWT token found. Redirecting to login page...');
            window.location.href = 'login.html';
        }

            const urlParams = new URLSearchParams(window.location.search);
            const jobName = urlParams.get('jobName');
           // console.log(jobName); 
            getJobByName(jobName);

            window.addEventListener("resize", function (event) {       
                stage_dock.handleResize();
            }, false);

            loadNGL();
            downloadDockingTable(jobName);
        };

      //  var stage_dock = new NGL.Stage("viewport", { backgroundColor: "white", cameraType: "orthographic" });

        function getJobByName(jobName){
            const token = localStorage.getItem('jwtToken');

            if (!token) {
                return Promise.reject(new Error("No authentication token found"));
            }

            return fetch(`/GeinForce/api/getJobByName?jobName=${jobName}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
              //  console.log("Job details:", data);
                document.getElementById('proteinFileName').textContent = data.proteinFile;
                document.getElementById('ligandFileName').textContent = data.ligandFiles;
                
                const proteinFileLink = document.getElementById('proteinFileLink');
                //proteinFileLink.onclick = () => downloadFile(data.jobName, 'protein', data.proteinFile);
                proteinFileLink.onclick = () => downloadFile(data.jobName, 'clean', data.proteinFile);
                
                const ligandFileLink = document.getElementById('ligandFileLink');
                ligandFileLink.onclick = () => downloadFile(data.jobName, 'ligand', data.ligandFiles);

                var coordinatesStr =  data.coordinates;
               // console.log(coordinatesStr);
                const jsonObject = JSON.parse(coordinatesStr);
                //coordinates  = `Center:{x: ${jsonObject.center.x}, y: ${jsonObject.center.y}, z: ${jsonObject.center.z}} Size:{${jsonObject.size.x}, ${jsonObject.size.y}, ${jsonObject.size.z}}`;
                coordinates = `Center:{x: ${jsonObject.center.x.toFixed(2)}, y: ${jsonObject.center.y.toFixed(2)}, z: ${jsonObject.center.z.toFixed(2)}} Size:{x: ${jsonObject.size.x.toFixed(2)}, y: ${jsonObject.size.y.toFixed(2)}, z: ${jsonObject.size.z.toFixed(2)}}`;
			    coordinates = `{${jsonObject.center.x.toFixed(2)},${jsonObject.center.y.toFixed(2)},${jsonObject.center.z.toFixed(2)}}`;
             //  coordinates =formatCoordinates(data.coordinates);
                return data;
            });
        }
        function formatCoordinates(coordString) {
    try {
        // Parse the JSON string
        const coords = JSON.parse(coordString);
        
        // Extract the values and join them
        const values = [coords.x, coords.y, coords.z].join(',');
        
        // Return the formatted string
        return `{${values}}`;
    } catch (error) {
        console.error('Error parsing coordinates:', error);
        return 'Invalid coordinate string';
    }
}

        function downloadFile(jobName, fileType, fileName) {
            showLoading();
            const token = localStorage.getItem('jwtToken');
            
            if (!token) {
                console.error("No authentication token found");
                hideLoading();
                return;
            }

            const url = `/GeinForce/api/download?jobName=${encodeURIComponent(jobName)}&fileType=${encodeURIComponent(fileType)}&fileName=${encodeURIComponent(fileName)}`;

            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    hideLoading();
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                hideLoading();
            })
            .catch(error => console.error('Download error:', error));
            hideLoading();
        }
    
        function loadNGL() {
            stage_dock.removeAllComponents();
            // Replace these with the actual job name and email
            const urlParams = new URLSearchParams(window.location.search);
            const jobName = urlParams.get('jobName');

            // Load the protein
            downloadAndLoadProtein(stage_dock, jobName);
        }
        function downloadAndLoadProtein(stage, jobName) {
            const token = localStorage.getItem('jwtToken');

            if (!token) {
                console.error("No authentication token found");
                return Promise.reject(new Error("No authentication token found"));
            }

            var url = `/GeinForce/api/getProteinFile?jobName=${encodeURIComponent(jobName)}`;
    
            return fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
            return response.blob();
            })
                .then(blob => {
                var blobUrl = URL.createObjectURL(blob);                    
                return loadFileIntoStage(stage, blobUrl, "cartoon", { backgroundColor: "white", cameraType: "orthographic" }, 'pdb', 0);
            })
            .catch(error => {
                console.error('Error loading protein file:', error);
                throw error; // Re-throw the error for upstream error handling
            });
        }
        function loadFileIntoStage(stage, filePath, representationType, representationParams, fileExtension,index) {
            stage.loadFile(filePath, { ext: "pdb" }).then(function (component) {
            component.addRepresentation(representationType, representationParams);
            component.autoView();
            //  console.log("Adding to map with index:", index);
            loadedComponentsMap[index] = component;
        });
}
        async function downloadDockingTable(jobName) {
            const token = localStorage.getItem('jwtToken');
    
            if (!token) {
                console.error("No authentication token found");
                return;
            }

            var url = `/GeinForce/api/getOutputTable?jobName=${encodeURIComponent(jobName)}`;
    
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';

                data.forEach(item => {
                   // console.log(item);
                    const row = document.createElement('tr');

                    const modeCell = document.createElement('td');
                    
                    const radioButton = document.createElement('input');
                    radioButton.type = 'checkbox';
                    radioButton.name = 'rowSelector';
                    radioButton.value = item.mode;
                    radioButton.id = `radio-${item.mode}`;
                    radioButton.className = 'radio-style-checkbox';

                    const label = document.createElement('label');
                    label.htmlFor = `checkbox-${item.mode}`;
                    label.className = 'radio-style-label';
                    
                    //modeCell.appendChild(radioButton);
                    //modeCell.appendChild(document.createTextNode(` ${item.mode}`));
                    modeCell.appendChild(radioButton);
                    modeCell.appendChild(label);
                    modeCell.appendChild(document.createTextNode(` ${item.mode}`));

                    
                    //modeCell.textContent = item.mode;
                    row.appendChild(modeCell);

                    const vinaScore = document.createElement('td');
                    vinaScore.textContent = item.affinity;
                    row.appendChild(vinaScore);

                    const coordinateCol = document.createElement('td');
                    coordinateCol.textContent = coordinates;
                    row.appendChild(coordinateCol);
                   // console.log(coordinates);

                    const linkContainer = document.createElement('div');
                    linkContainer.style.display = 'flex';
                    linkContainer.style.flexDirection = 'column';
                    linkContainer.style.alignItems = 'flex-start'; 

                    const ligandFileCell = document.createElement('td');
                   // console.log(item.ligand);
                    const extractLigandFileName = path => 
                    path.split('\\').pop().split('_').slice(-2).join('_');
                    var fileName = extractLigandFileName(item.ligand);

                   // console.log("Extracted ligand Name"+fileName);
                    // const fileName = item.ligand.split("\\").pop() || item.ligand.split("/").pop();
                    const ligNumber = fileName.split('_')[1].split('.')[0];
                    const fileLink = document.createElement('a');
                    fileLink.href = "javascript:void(0);"; // Prevent default link behavior
                    fileLink.textContent = "ligand_"+ligNumber+".pdb";
                    fileLink.textContent =fileName;
                    var LigfileName = jobName+'_'+fileName;
                    fileLink.onclick = (event) => {
                        event.preventDefault();
                        downloadFile(jobName, 'output', LigfileName);
                    };
                    // ligandFileCell.appendChild(fileLink);    
                    linkContainer.appendChild(fileLink);        
           
                    const complexFileName = item.complex.split("\\").pop() || item.complex.split("/").pop();
                    // const extractedNumber = complexFileName.split('_')[1].split('.')[0];
                    const extractedNumber=fileName.split('_')[1].split('.')[0]; 
                  //  console.log(fileName);
                    const complexFileLink = document.createElement('a');
                    complexFileLink.href = "javascript:void(0);";
                    complexFileLink.textContent ="Protein-ligand_complex_"+ extractedNumber+".pdb";
                    console.log('first file Name ',fileName);
                    var ligandFileName =jobName+'_' +fileName;
                    fileName = jobName+'_protein_'+fileName;
           
                    complexFileLink.onclick = (event) => {
                      //  console.log("Sending ligand fileName "+item.ligand);
                      showLoading();
                        event.preventDefault();
                       // alert("download complex");
                        downloadFile(jobName, 'protein-complex', item.ligand);
                        hideLoading();
                    };
                    //ligandFileCell.appendChild(complexFileLink);  
                    linkContainer.appendChild(complexFileLink);  
                    // row.appendChild(ligandFileCell);
                    row.appendChild(linkContainer);

                    row.addEventListener('click', (event) => {
                        if (event.target.tagName.toLowerCase() !== 'a') {
                           // console.log("GOt ligand");
                           //radioButton.checked = !radioButton.checked;
                            if (row.classList.contains('selected')) {
                                row.classList.remove('selected');
                                radioButton.checked=false;
                                removeComponentFromStage(stage_dock, item.mode);
                            } else {
                                radioButton.checked=true;
                                row.classList.add('selected');
                                console.log('file name of ligand ',ligandFileName);
                                downloadAndLoadOneLigand(stage_dock, jobName, 'output', ligandFileName, item.mode);
                            }
                        }
                    });
                    radioButton.addEventListener('change', () => {
                      
            });

                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
       

        
        




       
       
        function removeComponentFromStage(stage, index) {

const component = loadedComponentsMap[index];
if (component) {
// console.log("Current stage components before removal:", stage.compList);
    stage.removeComponent(component);
 //   console.log("Removing from map with index:", index);
    delete loadedComponentsMap[index];
  //  console.log("Current stage components after removal:", stage.compList);
    // component.removeAllRepresentations();
    // stage.autoView();
    // stage.requestRender();
} else {
    console.error(`Component ${index} not found.`);
}
}

async function downloadAndLoadOneLigand(stage, jobName, fileType, fileName, index) {
    try {
        const blob = await downloadFileAsBlob(jobName, fileType, fileName);
        const blobUrl = URL.createObjectURL(blob);
        
        // Call a function to load the file into the stage, adjust settings as needed
        loadFileIntoStage(stage, blobUrl, "ball+stick", { backgroundColor: "white", cameraType: "orthographic" }, 'pdb', index);
    } catch (error) {
        console.error('Error loading ligand file:', error);
    }
}
async function downloadFileAsBlob(jobName, fileType, fileName) {
    const token = localStorage.getItem('jwtToken');
    
    if (!token) {
        throw new Error("No authentication token found");
    }

    const url = `/GeinForce/api/download?jobName=${encodeURIComponent(jobName)}&fileType=${encodeURIComponent(fileType)}&fileName=${encodeURIComponent(fileName)}`;

    const response = await fetch(url, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });

    if (!response.ok) {
        throw new Error('Network response was not ok');
    }

    return response.blob();
}
async function isJwtTokenValid() {
            const token = localStorage.getItem('jwtToken');

            if (!token) {
                console.error('No token found in localStorage');
                return false;
            }

            const apiUrl = '/GeinForce/api/validateUser';
            const requestOptions = {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            };

            try {
                const response = await fetch(apiUrl, requestOptions);
                if (!response.ok) {
                    //throw new Error('Network response was not ok');
                    return false;
                }
                const result = await response.text();
               // console.log('Token validation result:', result);
                return result === 'Token is valid';
            } catch (error) {
                console.error('Error validating token:', error);
                localStorage.removeItem('jwtToken');
                return false;
            }
        }

    </script>
</body>
</html>